# Документация API

Здесь описан актуальный публичный API.

## Общие моменты
Почти каждый запрос требует передачи параметра **token**.

Это уникальный для каждого пользователя ключ. Получить его можно, зарегистрировавшись или же залогинившивсь, если вы уже зарегистрированы.

Методы для регистрации и авторизации описаны ниже.

Далее описаны реализованные методы.

## Регистрация нового пользователя

```
POST /api/v2/user/register
```

Параметры:
- **email** - Email. Он же уникальный идентификатор пользователя.
- **password** - пароль.

Если запрос выполнен успешно, возвратится JSON объект с **token** который в дальнейшем можно будет использовать в запросах. Пример успешного ответа:

```
{
"success":"true",
"token":"44e8d2698caa07e028e5685..."
}
```

Если где-то была допущена ошибка, вернется JSON объект с описанием ошибки:

```
{
"success":false,
"message":"User with this email already registered"
}
```

## Вход (логин)

```
POST /api/v2/user/login
```

Параметры:
- **email** - Email. Он же уникальный идентификатор пользователя.
- **password** - пароль.

Если запрос выполнен успешно, возвращается JSON объект с **token** вида:

```
{
"success":"true",
"token":"44e8d2698ca..."
}
```

В случае ошибки тоже возвращается JSON объект с описанием ошибки:

```
{
"success":false,
"message":"Invalid user params"
}
```

## Получить единичную задачу

```
GET /api/v2/task/getTaskData
```

Параметры:
- **String token**
- **String taskId** - уникальный идентификатор задачи.

В случае успеха запрос возвращает JSON объект с описанием задачи вида:

```
{
    "taskId": "html-1",
    "htmlDescription": "<p>Заголовок h1...",
    "mdDescription": "Заголовок h1 - ...",
    "initialHtml": "",
    "initialCss": "",
    "initialCode": "",
    "passed": "true",
    "metadata": {
       "videolink": "https://video.com"
    }
}
```

Описание полей:
- **taskId** - уникальный идентификатор задачи
- **htmlDescription** - описание задачи в HTML виде
- **mdDescription** - то же описание задачи, что и выше, но в markdown виде
- **initialHtml** - начальный текст, который нужно вставить в поле, где мы пишем **HTML**
- **initialCss** - начальный текст, который нужно вставить в поле, где мы пишем **CSS**
- **initialCode** - начальный текст, который нужно вставить в поле, где мы пишем **JS**. Сделано с целью возможного дальнейшего расширения.
- **passed** - решена ли эта задача пользователем, для которого выполняется запрос.
- **metadata** - key-value JSON массив

В случае ошибки возвращается JSON объект вида:

```
{
  "success": false,
  "message": "Task with id html-100 not present"
}
```

### Что может быть в metadata?
- **taskTitle** - как называется задача
- **needCss** - нужно ли показывать CSS редактор. Если поле есть и оно false - не показываем вообще CSS редактор.
- **cvLink** - абсолютный путь к картинке макета. Если этого поля нет - вообще не показываем кнопку **Показать макет**.
- **disableHtmlEditor** - нужно ли делать неактивным HTML редактор. Если поле есть и оно true - делаем нередактируемым html редактор.
- **disableCssEditor** - нужно ли делать неактивным CSS редактор. Если поле есть и оно true - делаем нередактируемым css редактор.

## Получить список задач

```
GET /api/v2/task/getTaskDataList
```

Параметры:
- **String token**
- **String filter** - опциональный параметр. Если передать его, то в ответ придут лишь те задачи, id которых включает в себя строку **filter**. Это можно использовать, например, чтобы получить задачи только по html - если мы знаем, что id этих задач содержит html в своем названии.

В случае успеха возвращается JSON объект следующего вида:

```
[
  {
    "taskId": "html-1",
    "htmlDescription": "<p>Заголовок h1...",
    "mdDescription": "Заголовок h1 - ...",
    "initialHtml": "",
    "initialCss": "",
    "initialCode": "",
    "metadata": {
        "videolink": "https://video.com"
    }
  },
  {
    "taskId": "html-2",
    "htmlDescription": "<p>Отдельные абзацы...",
    "mdDescription": "Отдельные абзацы...",
    "initialHtml": "<p>HTML - cool thing.</p>\r\n\r\n",
    "initialCss": "",
    "initialCode": "",
    "metadata": {
        "videolink": "https://video.com"
    }
  }
]
```

Это массив задач. Поля каждой задачи описаны в предыдущем методе.

Если же допущена ошибка, возвращается JSON объект с ошибкой вида:

```
{
  "success": false,
  "message": "Invalid token"
}
```

## Проверка задачи

Проверяем решенную пользователем задачу. Пользователь присылает текст решения, мы же возвращаем ему результат проверки.

```
POST /api/v2/task/check
```

Параметры:
R
- **String token**
- **String taskId** - идентификатор задачи
- **String html** - HTML, который вводит пользователь. Может быть пустым.
- **String css** - CSS, который вводит пользователь. Может быть пустым.
- **String js** - Javascript, который вводит пользователь. Может быть пустым.
- **solveTimeSeconds** - время решения в секундах. Можно не передавать.

Возвращает результат проверки в виде JSON объекта в следующем формате:

```
{
  "checkSuccess": true,
  "checkMessage": "",
  "successConditions": [
    "Другие теги, кроме h1, не обнаружены"
  ],
  "failedConditions": [
    "Тег h1 не найден"
  ],
  "taskSuccessfullyPassed": false
}
```

Описание полей:
- **checkSuccess** - получилось ли вообще проверить задачу. Если это поле false - значит, пошло что-то нереальное, и сервер поломался на этой задаче. Должно быть **true**.
- **checkMessage** - дополнительное информационное сообщение о результате проверки. Чаще всего будет пустым. Если поле **checkSuccess** будет равно **false**, то текущее поле может содержать описание ошибки.
- **successConditions** - удачные проверки, массив строк. Каждая строка - проверка, которую прошла задача.
- **failedConditions** - неудачные проверки, массив строк. Каждая строка - проверка, которую НЕ ПРОШЛА задача.
- **taskSuccessfullyPassed** - можно ли засчитывать пользователю эту задачу. По сути, это значит что нам получилось вообще проверить задачу, и все проверки удачные.

*ВАЖНО. Если пользователь решил задачу, она автоматически отмечается у него в профиле как решенная. То есть, именно бекенд решает засчитывать или не засчитывать задачу. Это правильно с точки зрения безопасности, чтобы не было возможных накруток.*

Если была ошибка, возвращается JSON объект вида:

```
{
  "success": false,
  "message": "Task with id html-10 not present"
}
```

### Быстрая проверка задачи
```
POST /api/v2/task/fastCheck
```

Проверяет задачу, не сохраняя информации о пользователе. Параметры и ответ такие же, как и у /api/v2/task/check

## Получить решенные пользователем задачи

```
GET /api/v2/task/getPassedTasks
```

Параметры:
- **String token**

В случае успеха возвращает массив идентификаторов решенных пользователем задач. Может быть пустым, если пользователь еще ничего не решал. Пример ответа:

```
[
  "html-1"
]
```

Если произошла ошибка, возвращается JSON объект вида:

```
{
  "success": false,
  "message": "Invalid token"
}
```

## Текущий блок заданий

Если юзер поблочно проходит задачи, ему каждый день высылается блок заданий.

Вот API, по которому можно получить информацию о текущем блоке:

`GET /api/v2/taskblock/get`

Параметры:
- **token** - уникальный для пользователя токен
- **block** - уникальный для каждого блока идентификатор

В случае успеха возвращает JSON вида:

```
{
   "success": true,
  "blockIndex": 1,
  "currentTask": "html-2",
  "blockTasks": [
    "html-1",
    "html-2",
    "html-3",
    "html-4",
    "html-5"
  ],
  "passedTasks": [
    "html-1"
  ],
  "userInMarathon": true,
  "marathonDay": 1
}
```

Описание полей:
- **success** - валидный ли токен и блок. true в случае успеха.
- **blockIndex** - порядковый номер блока. Нумерация начинается с 1.
- **currentTask** - идентификатор ближайшей нерешенной задачи в текущем блоке. Если все задачи в блоке уже решенные, то в этом поле будет ссылка на последнюю задачу из этого блока.
- **blockTasks** - список ВСЕХ идентификаторов задач в этом блоке
- **passedTasks** - список РЕШЕННЫХ юзером идентификаторов задач в этом блоке.
- **userInMarathon** - участвует ли текущий пользователь в блочном марафоне. Если false - то такой юзер есть в базе данных, но он не участвует в марафоне
- **marathonDay** - порядковый номер дня марафона. Может быть 0 или даже минусовым - это значит, что марафон для этого юзера еще не начался. В противном случае возвращает номер дня. Первый день - число 1. 

Если пользователь запрашивает блок задач, к которому у него нет доступа, выдается ошибка вида:

```
{
  "success": false,
  "message": "User should solve previous block"
}
```

Если что-то пошло не так, возвращаем JSON ошибки вида:

```
{
  "success": false,
  "message": "Invalid block index"
}
```


## ~~Получить прогресс пользователя в блочной модели (марафон)~~ (DEPRECATED, используйте getBlocksProgress)

```
GET /api/v2/taskblock/getTotalProgress
```

Параметры:
- **token**

Если запрос успешен, возвращает JSON объект вида:

```
{
  "success": true,
  "passedAllTasks": false,
  "nonFinishedDays": {
    "4": "https://cutt.ly/St2x73K"
  },
  "downloadArchiveLink": "linkToArchive",
  "finishedLastDay": true
}
```

Описание полей:
- **success** - true, если все ок
- **passedAllTasks** - решил ли пользователь все-все задачи (все дни 100%). **true** если да.
- **nonFinishedDays** - в этом поле хранятся ссылки на нерешенные дни. Ключ - номер дня, значение - сокращенная ссылка на нерешенный день.
- **downloadArchiveLink** - ссылка на загрузку архива с кодом. Здесь будет валидное значение только в случае, если поле **passedAllTasks** равно **true**.
- **finishedLastDay** - прошел ли юзер последний, 5-й день.

Если же допущена ошибка, возвращается JSON объект с ошибкой вида:

```
{
  "success": false,
  "message": "Invalid token"
}
```

## Получить прогресс пользователя по отдельным блокам

```
GET /api/v2/taskblock/getBlocksProgress
```

Параметры:
- **token**
- **blocks** - массив блоков, разделенных запятой, без пробела. 

Пример запроса:
```
http://host/api/v2/taskblock/getBlocksProgress/?token=6c175182fb7fd8decc3ed8c1141043141a9e11675bc07f3f0e62840139695ce2&blocks=juf31geq,74gfhj7l,jgfhk855
```

В примере выше три блока передано как параметр.

Если запрос успешен, возвращает JSON объект вида:

```
{
  "juf31geq": {
    "taskIds": [
      "html-1",
      "html-2",
      "html-3",
      "html-4",
      "html-5",
      "html-6",
      "html-7",
      "html-8",
      "html-9",
      "html-10"
    ],
    "solvedTaskIds": [
      "html-1"
    ],
    "progress": 10
  },
  "74gfhj7l": {
    "taskIds": [
      "html-11",
      "html-12",
      "html-13",
      "html-14",
      "html-15"
    ],
    "solvedTaskIds": [],
    "progress": 0
  },
  "jgfhk855": {
    "taskIds": [
      "css-1",
      "css-2",
      "css-3",
      "css-4",
      "css-5",
      "css-6",
      "css-7",
      "css-8",
      "css-9",
      "css-10",
      "css-11",
      "css-12",
      "css-13",
      "css-14",
      "css-15",
      "css-16",
      "css-17"
    ],
    "solvedTaskIds": [],
    "progress": 0
  }
}
```

То есть, возвращается ассоциативный массив (карта, map), где ключ - это hash блока. А значение - данные о блоке.

Описание полей:
- **taskIds** - массив задач, которые есть в блоке
- **solvedTasks** - массив **решенных** пользователем задач из этого блока.
- **progress** - число от 0 до 100. Прогресс пользователя по этому блоку.

Если же допущена ошибка, возвращается JSON объект с ошибкой вида:

```
{
  "success": false,
  "message": "Invalid token"
}
```